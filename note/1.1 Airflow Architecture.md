# Airflow Architecture

(이번 장은 Airflow 의 운영 관점에서 Airflow를 이해하는 것이 목표입니다)

<pre>
<b>환경 변수 설정 방법</b>

1. Environment variable (`AIRFLOW__[SECTION]__[KEY]`)
2. Command environment variable (`AIRFLOW__[SECTION]__[KEY]_CMD`)
3. In `airflow.cfg`
4. Command in `airflow.cfg`
5. Default value
</pre>

Airflow 는 세 개의 컴포넌트로 구성되어 있습니다.

- Webserver
- Scheduler
- Database

<br/><img src="./img/image1.png" width="60%" /><br/>

`Webserver` 와 `Scheduler` 모두 Airflow process 입니다.
데이터베이스는 분리된 서비스로, `Webserver` 와 `Scheduler에서` 메타데이터를 저장하기 위해 사용됩니다.
DAG들이 정의된 파일은 반드시 `Scheduler`가 접근할 수 있어야 합니다.


<br/>

#### Airflow 1

`Webserver` 와 `Scheduler`에서 반드시 DAG 파일들에 접근할 수 있게 해야 했습니다.
여러 머신 간에 파일들이 공유되어야 하거나 단순한 프로세스가 아니었기 때문에 이런 복잡한 배포가 필요했습니다.

<br/>

#### Airflow 2

DAG들은 데이터베이스 내 직렬화된(Serialized) 형태로 작성됩니다. `Webserver`는 이렇게 직렬화된 형식을 DB로 부터 읽었으며, 이런 이유로 DAG 에 접근할 필오가 없습니다.

DAG 들의 직렬화는 Airflow 1.10.10 버전부터, 선택적인 기능이지만, 가능합니다.

DAG의 직렬화를 가능하게 하려면 Airflow 1 (≥ 1.10.10) 에서 아래 옵션을 설정해서 사용할 수 있습니다.

- `AIRFLOW__CORE__STORE_DAG_CODE=True`
- `AIRFLOW__CORE__STORE_SERIALIZED_DAGS=True`

`Webserver`의 역할은 파이프라인의 현재 상태에 대해 시각적으로 나타내고 사용자들이 특정 액션을 할 수 있게, DAG를 트리거하는 등, 합니다.
`Scheduler`의 역할은 다음과 같습니다.

- DAG 파일을 파싱합니다 (즉, DAG 파일을 읽어 작게 부분들로 추출한다음, metastore에 저장합니다)
- 실행 태스크를 결정하고 큐에 넣습니다.

`Airflow`는 다양한 방식으로 설치될 수 있는데, 단일 컴퓨터 (설정을 위해 노력이 최소화되지만 스케일러블하지 않음) 혹은 다중 컴퓨터 (더 많은 초반 설정 작업이 필요하지만 수평확장이 가능함) 등이 있습니다.
`Airflow`에서는 executor 타입으로 다양한 실행 모드를 구성할 수 있습니다.

`AIRFLOW__CORE__EXECUTOR` 를 설정함으로써 executor를 구성할 수 있습니다.

| Executor             | Distributed | Ease of installation | Cood fit                                                              |
|----------------------|-------------|----------------------|-----------------------------------------------------------------------|
| `SequentialExecutor` | No          | Very easy            | Demoing/testing                                                       |
| `LocalExecutor`      | No          | Easy                 | When running on a single machine is good enough                       |
| `CeleryExecutor`     | Yes         | Moderate             | If you need to scale out over multiple machines                       |
| `KubernetesExecutor` | Yes         | Complex              | When you’re familiar with Kubernetes and prefer a containerized setup | 


